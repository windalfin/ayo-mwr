<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Configuration - Ayo MWR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        body {
            padding-top: 20px;
            padding-bottom: 40px;
        }
        .config-card {
            margin-bottom: 20px;
        }
        .camera-card {
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
        }
        .nav-tabs {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h1><i class="bi bi-camera-video-fill me-2"></i>Camera Configuration</h1>
                <p class="lead">Add, edit, and remove camera configurations</p>
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link" href="/admin"><i class="bi bi-gear me-1"></i>System Config</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/admin/cameras"><i class="bi bi-camera-video me-1"></i>Camera Config</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/dashboard"><i class="bi bi-display me-1"></i>Dashboard</a>
            </li>
        </ul>
        
        <!-- Camera List -->
        <div class="card config-card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-camera-video me-2"></i>Configured Cameras</span>
                    <button id="addCameraBtn" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus-lg me-1"></i>Add Camera
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="cameraList" class="mb-3">
                    <!-- Camera cards will be inserted here dynamically -->
                    <div class="text-center text-muted" id="noCamerasMessage">
                        <i class="bi bi-camera-video-off" style="font-size: 2rem;"></i>
                        <p>No cameras configured yet</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Camera Edit Modal -->
        <div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="cameraModalLabel">Add Camera</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="cameraForm">
                            <input type="hidden" id="cameraIndex" value="-1">
                            <div class="form-group mb-3">
                                <label for="cameraName">Camera Name</label>
                                <input type="text" class="form-control" id="cameraName" required>
                                <small class="form-text text-muted">Unique camera name (used for file naming)</small>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="cameraIP">IP Address</label>
                                        <input type="text" class="form-control" id="cameraIP" required placeholder="192.168.1.100">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="cameraPort">RTSP Port</label>
                                        <input type="text" class="form-control" id="cameraPort" required placeholder="554">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mb-3">
                                <label for="cameraPath">RTSP Path</label>
                                <input type="text" class="form-control" id="cameraPath" required placeholder="/cam/realmonitor?channel=1&subtype=0">
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="cameraUsername">Username</label>
                                        <input type="text" class="form-control" id="cameraUsername" placeholder="admin">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="cameraPassword">Password</label>
                                        <input type="password" class="form-control" id="cameraPassword">
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="cameraWidth">Width</label>
                                        <input type="number" class="form-control" id="cameraWidth" value="1280">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="cameraHeight">Height</label>
                                        <input type="number" class="form-control" id="cameraHeight" value="720">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="cameraFrameRate">Frame Rate</label>
                                        <input type="number" class="form-control" id="cameraFrameRate" value="30">
                                    </div>
                                </div>
                            </div>
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="cameraEnabled" checked>
                                <label class="form-check-label" for="cameraEnabled">Enabled</label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveCameraBtn">Save Camera</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete this camera?</p>
                        <p id="deleteCameraName" class="fw-bold"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Toast Notifications -->
        <div class="toast-container">
            <div id="saveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-success text-white">
                    <i class="bi bi-check-circle me-2"></i>
                    <strong class="me-auto">Success</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    Camera configuration saved successfully!
                </div>
            </div>
            <div id="deleteToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-danger text-white">
                    <i class="bi bi-trash me-2"></i>
                    <strong class="me-auto">Deleted</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    Camera deleted successfully!
                </div>
            </div>
            <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-danger text-white">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong class="me-auto">Error</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="errorToastMessage">
                    An error occurred.
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let cameras = [];
        let currentCameraIndex = -1;
        
        // Initialize Bootstrap toasts
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize all toasts
            const toastElList = [].slice.call(document.querySelectorAll('.toast'));
            toastElList.map(function(toastEl) {
                return new bootstrap.Toast(toastEl, {
                    autohide: true,
                    delay: 3000
                });
            });
            
            // Load cameras on page load
            loadCameras();
            
            // Add camera button click handler
            document.getElementById('addCameraBtn').addEventListener('click', function() {
                openCameraModal();
            });
            
            // Save camera button click handler
            document.getElementById('saveCameraBtn').addEventListener('click', function() {
                saveCamera();
            });
            
            // Confirm delete button click handler
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                deleteCamera();
            });
        });
        
        // Load cameras from API
        function loadCameras() {
            console.log('Loading cameras from API...');
            fetch('/api/config')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received configuration:', data);
                    if (data.Cameras && Array.isArray(data.Cameras)) {
                        // Normalize camera data to ensure uppercase property names
                        cameras = data.Cameras.map(cam => {
                            return {
                                Name: cam.Name || cam.name || '',
                                IP: cam.IP || cam.ip || '',
                                Port: cam.Port || cam.port || '554',
                                Path: cam.Path || cam.path || '',
                                Username: cam.Username || cam.username || '',
                                Password: cam.Password || cam.password || '',
                                Width: cam.Width || cam.width || 1280,
                                Height: cam.Height || cam.height || 720,
                                FrameRate: cam.FrameRate || cam.frame_rate || 30,
                                Enabled: cam.Enabled !== undefined ? cam.Enabled : (cam.enabled !== undefined ? cam.enabled : true),
                                Field: cam.Field || cam.field || '',
                                Resolution: cam.Resolution || cam.resolution || ''
                            };
                        });
                        console.log('Cameras loaded and normalized:', cameras);
                        renderCameraList();
                    } else {
                        console.log('No cameras found in config or invalid format');
                        cameras = [];
                        renderCameraList();
                    }
                })
                .catch(error => {
                    console.error('Error loading cameras:', error);
                    showErrorToast('Failed to load camera configuration');
                });
        }
        
        // Render camera list
        function renderCameraList() {
            const cameraList = document.getElementById('cameraList');
            
            // Clear existing content
            cameraList.innerHTML = '';
            
            // Create or get no cameras message element
            let noCamerasMessage = document.getElementById('noCamerasMessage');
            if (!noCamerasMessage) {
                noCamerasMessage = document.createElement('div');
                noCamerasMessage.id = 'noCamerasMessage';
                noCamerasMessage.className = 'text-center text-muted';
                noCamerasMessage.innerHTML = `
                    <i class="bi bi-camera-video-off" style="font-size: 2rem;"></i>
                    <p>No cameras configured yet</p>
                `;
            }
            
            // Show/hide no cameras message
            if (cameras.length === 0) {
                cameraList.appendChild(noCamerasMessage);
                return;
            }
            
            // Create camera cards
            cameras.forEach((camera, index) => {
                const card = document.createElement('div');
                card.className = 'card mb-3';
                
                // Build RTSP URL for display
                const rtspUrl = `rtsp://${camera.Username ? camera.Username : ''}${camera.Password ? ':' + camera.Password : ''}${(camera.Username || camera.Password) ? '@' : ''}${camera.IP}:${camera.Port}${camera.Path}`;
                
                card.innerHTML = `
                    <div class="card-header d-flex justify-content-between align-items-center ${camera.Enabled ? 'bg-success text-white' : 'bg-secondary text-white'}">
                        <span>
                            <i class="bi ${camera.Enabled ? 'bi-camera-video' : 'bi-camera-video-off'} me-2"></i>
                            ${camera.Name || 'Unnamed Camera'}
                        </span>
                        <div>
                            <button class="btn btn-sm btn-light edit-camera" data-index="${index}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-camera" data-index="${index}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="mb-1"><strong>IP:</strong> ${camera.IP || 'Not specified'}</p>
                        <p class="mb-1"><strong>Port:</strong> ${camera.Port || '554'}</p>
                        <p class="mb-1"><strong>RTSP URL:</strong> ${rtspUrl}</p>
                        <p class="mb-1"><strong>Resolution:</strong> ${camera.Width || 1280}x${camera.Height || 720} @ ${camera.FrameRate || 30}fps</p>
                        <p class="mb-0"><strong>Status:</strong> 
                            <span class="badge ${camera.Enabled ? 'bg-success' : 'bg-secondary'}">
                                ${camera.Enabled ? 'Enabled' : 'Disabled'}
                            </span>
                        </p>
                    </div>
                `;
                cameraList.appendChild(card);
                
                // Add event listeners to buttons
                card.querySelector('.edit-camera').addEventListener('click', function() {
                    openCameraModal(index);
                });
                
                card.querySelector('.delete-camera').addEventListener('click', function() {
                    openDeleteModal(index);
                });
            });
        }
        
        // Open camera modal for add/edit
        function openCameraModal(index = -1) {
            // Set modal title
            const modalTitle = document.getElementById('cameraModalLabel');
            modalTitle.textContent = index >= 0 ? 'Edit Camera' : 'Add Camera';
            
            // Set form values
            document.getElementById('cameraIndex').value = index;
            
            if (index >= 0 && index < cameras.length) {
                // Edit existing camera
                const camera = cameras[index];
                document.getElementById('cameraName').value = camera.Name || '';
                document.getElementById('cameraIP').value = camera.IP || '';
                document.getElementById('cameraPort').value = camera.Port || '554';
                document.getElementById('cameraPath').value = camera.Path || '';
                document.getElementById('cameraUsername').value = camera.Username || '';
                document.getElementById('cameraPassword').value = camera.Password || '';
                document.getElementById('cameraWidth').value = camera.Width || 1280;
                document.getElementById('cameraHeight').value = camera.Height || 720;
                document.getElementById('cameraFrameRate').value = camera.FrameRate || 30;
                document.getElementById('cameraEnabled').checked = camera.Enabled !== false;
            } else {
                // Add new camera
                document.getElementById('cameraName').value = '';
                document.getElementById('cameraIP').value = '';
                document.getElementById('cameraPort').value = '554';
                document.getElementById('cameraPath').value = '/cam/realmonitor?channel=1&subtype=0';
                document.getElementById('cameraUsername').value = '';
                document.getElementById('cameraPassword').value = '';
                document.getElementById('cameraWidth').value = 1280;
                document.getElementById('cameraHeight').value = 720;
                document.getElementById('cameraFrameRate').value = 30;
                document.getElementById('cameraEnabled').checked = true;
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('cameraModal'));
            modal.show();
        }
        
        // Open delete confirmation modal
        function openDeleteModal(index) {
            if (index >= 0 && index < cameras.length) {
                currentCameraIndex = index;
                const camera = cameras[index];
                const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
                document.getElementById('deleteCameraName').textContent = camera.Name || 'Unnamed Camera';
                modal.show();
            }
        }
        
        // Save camera (add or update)
        function saveCamera() {
            const form = document.getElementById('cameraForm');
            
            // Basic validation
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Get form values
            const index = parseInt(document.getElementById('cameraIndex').value);
            const camera = {
                Name: document.getElementById('cameraName').value,
                IP: document.getElementById('cameraIP').value,
                Port: document.getElementById('cameraPort').value,
                Path: document.getElementById('cameraPath').value,
                Username: document.getElementById('cameraUsername').value,
                Password: document.getElementById('cameraPassword').value,
                Width: parseInt(document.getElementById('cameraWidth').value) || 1280,
                Height: parseInt(document.getElementById('cameraHeight').value) || 720,
                FrameRate: parseInt(document.getElementById('cameraFrameRate').value) || 30,
                Enabled: document.getElementById('cameraEnabled').checked
            };
            
            console.log('Saving camera:', camera, 'at index:', index);
            
            // Add or update camera in array
            if (index >= 0 && index < cameras.length) {
                // Update existing camera
                cameras[index] = camera;
            } else {
                // Add new camera
                cameras.push(camera);
            }
            
            // Save updated cameras to config
            saveConfig();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('cameraModal'));
            modal.hide();
        }
        
        // Delete camera
        function deleteCamera() {
            if (currentCameraIndex >= 0 && currentCameraIndex < cameras.length) {
                console.log('Deleting camera at index:', currentCameraIndex);
                
                // Remove camera from array
                cameras.splice(currentCameraIndex, 1);
                
                // Save updated cameras to config
                saveConfig();
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                modal.hide();
                
                // Show delete toast
                const toast = bootstrap.Toast.getOrCreateInstance(document.getElementById('deleteToast'));
                toast.show();
            }
        }
        
        // Save config to API
        function saveConfig() {
            // Get current config
            fetch('/api/config')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load configuration');
                    }
                    return response.json();
                })
                .then(config => {
                    // Ensure cameras have the correct property format for Go struct
                    const formattedCameras = cameras.map(cam => {
                        return {
                            name: cam.Name || '',
                            ip: cam.IP || '',
                            port: cam.Port || '554',
                            path: cam.Path || '',
                            username: cam.Username || '',
                            password: cam.Password || '',
                            width: parseInt(cam.Width) || 1280,
                            height: parseInt(cam.Height) || 720,
                            frame_rate: parseInt(cam.FrameRate) || 30,
                            enabled: cam.Enabled,
                            field: cam.Field || '',
                            resolution: cam.Resolution || ''
                        };
                    });
                    
                    // Update cameras in config
                    config.Cameras = formattedCameras;
                    
                    console.log('Saving config with cameras:', config.Cameras);
                    
                    // Save updated config
                    return fetch('/api/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(config)
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to save configuration');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Configuration saved successfully:', data);
                    
                    // Show success toast
                    const saveToast = document.getElementById('saveToast');
                    const toast = new bootstrap.Toast(saveToast);
                    toast.show();
                    
                    // Reload cameras to ensure we have the latest data
                    loadCameras();
                })
                .catch(error => {
                    console.error('Error saving configuration:', error);
                    showErrorToast('Failed to save configuration: ' + error.message);
                });
        }
        
        // Show error toast with custom message
        function showErrorToast(message) {
            const errorToast = document.getElementById('errorToast');
            document.getElementById('errorToastMessage').textContent = message;
            const toast = bootstrap.Toast.getOrCreateInstance(errorToast);
            toast.show();
        }
    </script>
</body>
</html>
