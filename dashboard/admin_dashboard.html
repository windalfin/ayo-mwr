<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AYO Middleware Admin Dashboard</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 0;
      color: #222;
      --primary-color: #273c75;
      --secondary-color: #dcdde1;
      --success-color: #27ae60;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --light-gray: #f5f6fa;
      --dark-gray: #7f8c8d;
    }
    header {
      background: #273c75;
      color: #fff;
      padding: 1.2rem 2rem;
      font-size: 1.5rem;
      letter-spacing: 1px;
      font-weight: 600;
    }
    nav {
      display: flex;
      background: #dcdde1;
      padding: 0.5rem 2rem;
      gap: 2rem;
    }
    nav a {
      color: #273c75;
      text-decoration: none;
      font-weight: 500;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      transition: background 0.2s;
    }
    nav a.active, nav a:hover {
      background: #f5f6fa;
    }
    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .summary-cards {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    .card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      padding: 1.2rem 2rem;
      flex: 1 1 200px;
      min-width: 180px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .card h2 {
      margin: 0 0 0.5rem 0;
      font-size: 2rem;
      color: #273c75;
    }
    .card span {
      font-size: 1rem;
      color: #888;
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .password-input-container {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .password-input {
      flex: 1;
      padding-right: 35px; /* Space for the toggle button */
    }
    
    .toggle-password {
      position: absolute;
      right: 8px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      color: #666;
      font-size: 16px;
    }
    
    .toggle-password:focus {
      outline: none;
      color: #007bff;
    }
    
    .form-group input[type="text"],
    .form-group input[type="password"],
    .form-group input[type="number"],
    .form-group select {
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }

    .btn-secondary {
      background-color: var(--secondary-color);
      color: #333;
    }

    .btn-success {
      background-color: var(--success-color);
      color: white;
    }

    .btn-danger {
      background-color: var(--danger-color);
      color: white;
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      overflow-y: auto;
      padding: 20px;
      box-sizing: border-box;
    }

    .modal-content {
      background-color: white;
      margin: 2% auto;
      padding: 2rem;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      position: relative;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      max-height: 90vh;
      overflow-y: auto;
    }
    
    @media (max-height: 700px) {
      .modal-content {
        margin: 10px auto;
        max-height: 95vh;
      }
    }

    .close {
      position: absolute;
      right: 1.5rem;
      top: 1rem;
      font-size: 1.5rem;
      cursor: pointer;
    }

    /* Table Styles */
    .camera-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }

    .camera-table th,
    .camera-table td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    .camera-table th {
      background-color: var(--light-gray);
      font-weight: 600;
    }

    .camera-table tr:hover {
      background-color: #f8f9fa;
    }

    .camera-actions {
      display: flex;
      gap: 0.5rem;
    }

    .camera-config-actions {
      margin-bottom: 1.5rem;
      display: flex;
      gap: 1rem;
    }
    
    /* Notification Styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 4px;
      color: white;
      z-index: 1000;
      opacity: 1;
      transition: opacity 0.3s ease-in-out;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .notification.success {
      background-color: var(--success-color);
    }
    
    .notification.error {
      background-color: var(--danger-color);
    }
    
    .notification.info {
      background-color: var(--primary-color);
    }
    
    .notification.warning {
      background-color: var(--warning-color);
    }
    
    .notification.fade-out {
      opacity: 0;
    }
    h3 {
      margin-top: 2rem;
      margin-bottom: 1rem;
      color: #273c75;
      font-size: 1.3rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 5px rgba(0,0,0,0.05);
    }
    th, td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid #f1f1f1;
    }
    th {
      background: #f5f6fa;
      font-weight: 600;
      color: #273c75;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .status {
      font-weight: bold;
      padding: 0.2em 0.8em;
      border-radius: 12px;
      font-size: 0.95em;
      display: inline-block;
    }
    .status.active { background: #4cd137; color: #fff; }
    .status.offline { background: #e84118; color: #fff; }
    .status.processing { background: #fbc531; color: #222; }
    .status.failed { background: #e84118; color: #fff; }
    .status.uploading { background: #0097e6; color: #fff; }
    .status.ready { background: #44bd32; color: #fff; }
    .actions button {
      background: #273c75;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.3em 1em;
      margin-right: 0.5em;
      cursor: pointer;
      font-size: 0.95em;
      transition: background 0.2s;
    }
    .actions button:hover { background: #353b48; }
    .filters {
      margin: 1rem 0 1.5rem 0;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .filters input, .filters select {
      padding: 0.4em 0.8em;
      border: 1px solid #dcdde1;
      border-radius: 6px;
      font-size: 1em;
      background: #fff;
    }
    .log-list {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.05);
      padding: 1.2rem 2rem;
      margin-bottom: 2rem;
      font-family: monospace;
      font-size: 1em;
      max-height: 320px;
      overflow-y: auto;
    }
    @media (max-width: 900px) {
      .summary-cards { flex-direction: column; }
      .container { padding: 0 0.5rem; }
    }
    @media (max-width: 600px) {
      nav { flex-direction: column; gap: 0.5rem; }
      .card { padding: 1rem; }
      th, td { padding: 0.5rem 0.5rem; }
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border-radius: 10px;
      width: 80%;
      max-width: 800px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .modal-header h4 {
      margin: 0;
      color: #273c75;
      font-size: 1.4rem;
    }
    
    .close-modal {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close-modal:hover {
      color: #273c75;
    }
    
    .video-container {
      width: 100%;
      background: #000;
      position: relative;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 15px;
    }
    
    #video-player {
      width: 100%;
      display: block;
    }
    
    .video-controls {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    
    .video-controls button {
      background: #273c75;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 0.95em;
      transition: background 0.2s;
    }
    
    .video-controls button:hover {
      background: #353b48;
    }
  </style>
</head>
<body>
  <header>AYO Middleware Admin Dashboard</header>
  <nav>
    <a href="#cameras" class="active" data-tab="cameras">Cameras</a>
    <a href="#videos" data-tab="videos">Videos/Clips</a>
    <a href="#camera-config" data-tab="camera-config">Camera Config</a>
    <a href="#system-config" data-tab="system-config">System Config</a>
    <a href="#system" data-tab="system">System Health</a>
    <a href="#logs" data-tab="logs">Logs</a>
  </nav>
  <div class="container">
    <!-- Summary Cards -->
    <div class="summary-cards" id="summary-cards">
      <!-- Arduino Status Card -->
      <div class="card" id="arduino-status-card" style="flex:1 1 250px;cursor:pointer">
        <h2 id="arduino-status-text">Disconnected</h2>
        <span id="arduino-status-details">Port: -</span>
      </div>
      <div class="card">
        <h2>4</h2>
        <span>Cameras</span>
      </div>
      <div class="card">
        <h2>3</h2>
        <span>Active</span>
      </div>
      <div class="card">
        <h2>2</h2>
        <span>Failed Videos</span>
      </div>
      <div class="card">
        <h2>12%</h2>
        <span>CPU Usage</span>
      </div>
      <div class="card">
        <h2>420MB</h2>
        <span>Memory</span>
      </div>
    </div>

    <!-- Cameras Table -->
    <section class="tab-section" id="tab-cameras">
      <h3>Cameras</h3>
      <div class="filters">
        <input type="text" placeholder="Search by name or IP" id="camera-search">
        <select id="camera-status-filter">
          <option value="all">Status: All</option>
          <option value="active">Active</option>
          <option value="offline">Offline</option>
        </select>
      </div>
      <table id="cameras-table">
        <thead>
          <tr>
            <th>Name</th><th>IP</th><th>Port</th><th>Path</th><th>Status</th><th>Last Checked</th><th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Camera rows will be populated by JS -->
        </tbody>
      </table>
    </section>

    <!-- Videos Table -->
    <section class="tab-section" id="tab-videos" style="display:none">
      <h3>Videos / Clips</h3>
      <div class="filters">
        <select id="video-status-filter">
          <option value="all">Status: All</option>
          <option value="ready">Ready</option>
          <option value="uploading">Uploading</option>
          <option value="processing">Processing</option>
          <option value="failed">Failed</option>
        </select>
        <select id="video-camera-filter">
          <option value="all">Camera: All</option>
        </select>
        <input type="date" id="video-date-filter">
        <input type="text" placeholder="Search by ID" id="video-id-search">
      </div>
      <table id="videos-table">
        <thead>
          <tr>
            <th>ID</th><th>Camera</th><th>Status</th><th>Created At</th><th>Duration</th><th>Size</th><th>Cloud?</th><th>Error</th><th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Video rows will be populated by JS -->
        </tbody>
      </table>
    </section>

    <!-- Camera Config Tab -->
    <section class="tab-section" id="tab-camera-config" style="display:none">
      <h3>Camera Configuration</h3>
      <div class="camera-config-actions">
        <button id="add-camera-btn" class="btn btn-primary">Add Camera</button>
        <button id="reload-config-btn" class="btn btn-secondary">Reload Config</button>
        <button id="save-config-btn" class="btn btn-success">Save Changes</button>
      </div>
      
      <!-- Camera Config Table -->
      <table id="camera-config-table" class="camera-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>IP</th>
            <th>Port</th>
            <th>Path</th>
            <th>Username</th>
            <th>Field ID</th>
            <th>Button No</th>
            <th>Enabled</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="camera-config-tbody">
          <!-- Will be populated by JavaScript -->
        </tbody>
      </table>

      <!-- Camera Form Modal -->
      <div id="camera-form-modal" class="modal" style="display: none;">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h3 id="modal-title">Add Camera</h3>
          <form id="camera-form">
            <input type="hidden" id="camera-index" value="-1">
            <div class="form-group">
              <label for="camera-name">Name</label>
              <input type="text" id="camera-name" required>
            </div>
            <div class="form-group">
              <label for="camera-ip">IP Address</label>
              <input type="text" id="camera-ip" required>
            </div>
            <div class="form-group">
              <label for="camera-port">Port</label>
              <input type="text" id="camera-port" value="80">
            </div>
            <div class="form-group">
              <label for="camera-path">Path</label>
              <input type="text" id="camera-path" value="/video/mjpg.cgi">
            </div>
            <div class="form-group">
              <label for="camera-username">Username</label>
              <input type="text" id="camera-username">
            </div>
            <div class="form-group">
              <label for="camera-password">Password</label>
              <div class="password-input-container">
                <input type="password" id="camera-password" class="password-input" autocomplete="off">
                <button type="button" class="toggle-password" aria-label="Show password" tabindex="0">
                  <span class="eye-icon">🙈</span>
                </button>
              </div>
            </div>
            <div class="form-group">
              <label for="camera-field-id">Field ID</label>
              <input type="text" id="camera-field-id" placeholder="e.g., field_1, main, court_a">
            </div>
            <div class="form-group">
              <label for="camera-button-no">Button Number</label>
              <input type="text" id="camera-button-no" placeholder="e.g., 1, 2, 3">
            </div>
            <div class="form-group">
              <label for="camera-enabled">
                <input type="checkbox" id="camera-enabled" checked>
                Enabled
              </label>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-secondary" id="cancel-camera">Cancel</button>
              <button type="submit" class="btn btn-primary">Save</button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- System Config Tab -->
    <section class="tab-section" id="tab-system-config" style="display:none">
      <h3>System Configuration</h3>
      <div class="camera-config-actions">
        <button id="load-system-config-btn" class="btn btn-secondary">Load Config</button>
        <button id="save-system-config-btn" class="btn btn-success">Save Changes</button>
      </div>
      
      <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 1px 5px rgba(0,0,0,0.05);">
        <h4 style="margin-top: 0; color: #273c75;">Worker Concurrency Settings</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
          <div class="form-group">
            <label for="booking-worker-concurrency">Booking Worker Concurrency</label>
            <input type="number" id="booking-worker-concurrency" min="1" max="10" value="2">
            <small style="color: #666; font-size: 0.9em;">Number of concurrent booking video processing workers (1-10)</small>
          </div>
          <div class="form-group">
            <label for="video-request-worker-concurrency">Video Request Worker Concurrency</label>
            <input type="number" id="video-request-worker-concurrency" min="1" max="10" value="3">
            <small style="color: #666; font-size: 0.9em;">Number of concurrent video request processing workers (1-10)</small>
          </div>
          <div class="form-group">
            <label for="pending-task-worker-concurrency">Pending Task Worker Concurrency</label>
            <input type="number" id="pending-task-worker-concurrency" min="1" max="10" value="2">
            <small style="color: #666; font-size: 0.9em;">Number of concurrent pending task processing workers (1-10)</small>
          </div>
        </div>
        
        <h4 style="color: #273c75;">Quality Presets Configuration</h4>
        <div class="form-group">
          <label for="enabled-qualities">Enabled Qualities</label>
          <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.5rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="checkbox" class="quality-checkbox" value="1080p" checked>
              1080p (Full HD)
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="checkbox" class="quality-checkbox" value="720p" checked>
              720p (HD)
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="checkbox" class="quality-checkbox" value="480p">
              480p (SD)
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="checkbox" class="quality-checkbox" value="360p">
              360p (Low)
            </label>
          </div>
          <small style="color: #666; font-size: 0.9em; display: block; margin-top: 0.5rem;">Select which quality presets should be available for transcoding</small>
        </div>
        
        <h4 style="color: #273c75; margin-top: 2rem;">Video Processing Configuration</h4>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 0.5rem;">
            <input type="checkbox" id="enable-video-duration-check">
            Enable Video Duration Check
          </label>
          <small style="color: #666; font-size: 0.9em; display: block; margin-top: 0.5rem;">When enabled, videos with insufficient duration will be rejected and marked as unavailable. Default: disabled</small>
        </div>
        
        <!-- Venue Configuration -->
        <h4 style="color: #273c75; margin-top: 2rem;">Venue Configuration</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
          <div class="form-group">
            <label for="venue-code">Venue Code</label>
            <input type="text" id="venue-code" placeholder="Enter venue code">
            <small style="color: #666; font-size: 0.9em;">Unique identifier for this venue (no default value)</small>
          </div>
          <div class="form-group">
            <label for="venue-secret-key">Venue Secret Key</label>
            <div class="password-input-container">
              <input type="password" id="venue-secret-key" class="password-input" placeholder="Enter secret key">
              <button type="button" class="toggle-password" onclick="togglePassword('venue-secret-key')">
                <span class="eye-icon">🙈</span>
              </button>
            </div>
            <small style="color: #666; font-size: 0.9em;">Secret key for venue authentication (no default value)</small>
          </div>
        </div>
        
        <!-- Arduino Configuration -->
        <h4 style="color: #273c75; margin-top: 2rem;">Arduino Configuration</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
          <div class="form-group">
            <label for="arduino-com-port">COM Port</label>
            <input type="text" id="arduino-com-port" placeholder="/dev/ttyUSB0">
            <small style="color: #666; font-size: 0.9em;">Serial port for Arduino communication</small>
          </div>
          <div class="form-group">
            <label for="arduino-baud-rate">Baud Rate</label>
            <input type="number" id="arduino-baud-rate" min="9600" max="115200" value="9600">
            <small style="color: #666; font-size: 0.9em;">Serial communication speed</small>
          </div>
        </div>
        
        <!-- RTSP Configuration (Legacy) -->
        <h4 style="color: #273c75; margin-top: 2rem;">RTSP Configuration (Legacy Single Camera)</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
          <div class="form-group">
            <label for="rtsp-username">RTSP Username</label>
            <input type="text" id="rtsp-username" placeholder="admin">
            <small style="color: #666; font-size: 0.9em;">Username for RTSP authentication</small>
          </div>
          <div class="form-group">
            <label for="rtsp-password">RTSP Password</label>
            <div class="password-input-container">
              <input type="password" id="rtsp-password" class="password-input" placeholder="admin123">
              <button type="button" class="toggle-password" onclick="togglePassword('rtsp-password')">
                <span class="eye-icon">🙈</span>
              </button>
            </div>
            <small style="color: #666; font-size: 0.9em;">Password for RTSP authentication</small>
          </div>
          <div class="form-group">
            <label for="rtsp-ip">RTSP IP Address</label>
            <input type="text" id="rtsp-ip" placeholder="192.168.1.100">
            <small style="color: #666; font-size: 0.9em;">IP address of the RTSP camera</small>
          </div>
          <div class="form-group">
            <label for="rtsp-port">RTSP Port</label>
            <input type="number" id="rtsp-port" min="1" max="65535" value="554">
            <small style="color: #666; font-size: 0.9em;">Port number for RTSP connection</small>
          </div>
          <div class="form-group">
            <label for="rtsp-path">RTSP Path</label>
            <input type="text" id="rtsp-path" placeholder="/stream1">
            <small style="color: #666; font-size: 0.9em;">RTSP stream path</small>
          </div>
        </div>
        
        <!-- Recording Configuration -->
        <h4 style="color: #273c75; margin-top: 2rem;">Recording Configuration</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
          <div class="form-group">
            <label for="segment-duration">Segment Duration (seconds)</label>
            <input type="number" id="segment-duration" min="1" max="60" value="10">
            <small style="color: #666; font-size: 0.9em;">Duration of each video segment</small>
          </div>
          <div class="form-group">
            <label for="clip-duration">Clip Duration (seconds)</label>
            <input type="number" id="clip-duration" min="10" max="300" value="30">
            <small style="color: #666; font-size: 0.9em;">Duration of video clips</small>
          </div>
          <div class="form-group">
            <label for="width">Video Width</label>
            <input type="number" id="width" min="320" max="3840" value="1920">
            <small style="color: #666; font-size: 0.9em;">Video width in pixels</small>
          </div>
          <div class="form-group">
            <label for="height">Video Height</label>
            <input type="number" id="height" min="240" max="2160" value="1080">
            <small style="color: #666; font-size: 0.9em;">Video height in pixels</small>
          </div>
          <div class="form-group">
            <label for="frame-rate">Frame Rate (fps)</label>
            <input type="number" id="frame-rate" min="1" max="60" value="30">
            <small style="color: #666; font-size: 0.9em;">Frames per second</small>
          </div>
          <div class="form-group">
            <label for="resolution">Resolution</label>
            <input type="text" id="resolution" placeholder="1920x1080">
            <small style="color: #666; font-size: 0.9em;">Video resolution format</small>
          </div>
          <div class="form-group">
            <label for="auto-delete">Auto Delete (Days)</label>
            <input type="number" id="auto-delete" min="1" max="365" value="30">
            <small style="color: #666; font-size: 0.9em;">Automatically delete video files after specified days (1-365)</small>
          </div>
        </div>
        
        <!-- Storage Configuration -->
        <h4 style="color: #273c75; margin-top: 2rem;">Storage Configuration</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
          <div class="form-group">
            <label for="storage-path">Storage Path</label>
            <input type="text" id="storage-path" placeholder="./storage">
            <small style="color: #666; font-size: 0.9em;">Local storage directory path</small>
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="checkbox" id="hardware-accel">
              Hardware Acceleration
            </label>
            <small style="color: #666; font-size: 0.9em;">Enable hardware acceleration for video processing</small>
          </div>
          <div class="form-group">
            <label for="codec">Video Codec</label>
            <input type="text" id="codec" placeholder="h264">
            <small style="color: #666; font-size: 0.9em;">Video encoding codec (e.g., h264, h265, vp8, vp9)</small>
          </div>
        </div>
        
        <!-- Server Configuration -->
        <h4 style="color: #273c75; margin-top: 2rem;">Server Configuration</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
          <div class="form-group">
            <label for="server-port">Server Port</label>
            <input type="number" id="server-port" min="1" max="65535" value="8080">
            <small style="color: #666; font-size: 0.9em;">HTTP server port</small>
          </div>
          <div class="form-group">
            <label for="base-url">Base URL</label>
            <input type="text" id="base-url" placeholder="http://localhost:8080">
            <small style="color: #666; font-size: 0.9em;">Base URL for the application</small>
          </div>

        </div>
        
        <!-- R2 Storage Configuration -->
        <h4 style="color: #273c75; margin-top: 2rem;">R2 Storage Configuration</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="checkbox" id="r2-enabled">
              Enable R2 Storage
            </label>
            <small style="color: #666; font-size: 0.9em;">Enable Cloudflare R2 storage integration</small>
          </div>
          <div class="form-group">
            <label for="r2-access-key">R2 Access Key</label>
            <div class="password-input-container">
              <input type="password" id="r2-access-key" class="password-input" placeholder="Enter access key">
              <button type="button" class="toggle-password" onclick="togglePassword('r2-access-key')">
                <span class="eye-icon">🙈</span>
              </button>
            </div>
            <small style="color: #666; font-size: 0.9em;">R2 access key for authentication</small>
          </div>
          <div class="form-group">
            <label for="r2-secret-key">R2 Secret Key</label>
            <div class="password-input-container">
              <input type="password" id="r2-secret-key" class="password-input" placeholder="Enter secret key">
              <button type="button" class="toggle-password" onclick="togglePassword('r2-secret-key')">
                <span class="eye-icon">🙈</span>
              </button>
            </div>
            <small style="color: #666; font-size: 0.9em;">R2 secret key for authentication</small>
          </div>
          <div class="form-group">
            <label for="r2-account-id">R2 Account ID</label>
            <input type="text" id="r2-account-id" placeholder="Enter account ID">
            <small style="color: #666; font-size: 0.9em;">Cloudflare account ID</small>
          </div>
          <div class="form-group">
            <label for="r2-bucket">R2 Bucket Name</label>
            <input type="text" id="r2-bucket" placeholder="ayo-mwr">
            <small style="color: #666; font-size: 0.9em;">R2 bucket name for storage</small>
          </div>
          <div class="form-group">
            <label for="r2-region">R2 Region</label>
            <input type="text" id="r2-region" placeholder="auto">
            <small style="color: #666; font-size: 0.9em;">R2 storage region</small>
          </div>
          <div class="form-group">
            <label for="r2-endpoint">R2 Endpoint</label>
            <input type="text" id="r2-endpoint" placeholder="Enter endpoint URL">
            <small style="color: #666; font-size: 0.9em;">R2 API endpoint URL</small>
          </div>
          <div class="form-group">
            <label for="r2-base-url">R2 Base URL</label>
            <input type="text" id="r2-base-url" placeholder="Enter base URL">
            <small style="color: #666; font-size: 0.9em;">R2 public base URL</small>
          </div>
          <div class="form-group">
            <label for="r2-token-value">R2 Token Value</label>
            <div class="password-input-container">
              <input type="password" id="r2-token-value" class="password-input" placeholder="Enter token">
              <button type="button" class="toggle-password" onclick="togglePassword('r2-token-value')">
                <span class="eye-icon">🙈</span>
              </button>
            </div>
            <small style="color: #666; font-size: 0.9em;">R2 authentication token</small>
          </div>
        </div>
        
        <!-- Watermark Configuration -->
        <h4 style="color: #273c75; margin-top: 2rem;">Watermark Configuration</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
          <div class="form-group">
            <label for="watermark-position">Watermark Position</label>
            <select id="watermark-position">
               <option value="top_left">Top Left</option>
               <option value="top_right">Top Right</option>
               <option value="bottom_left">Bottom Left</option>
               <option value="bottom_right" selected>Bottom Right</option>
               <option value="center">Center</option>
             </select>
            <small style="color: #666; font-size: 0.9em;">Position of watermark on video</small>
          </div>
          <div class="form-group">
            <label for="watermark-margin">Watermark Margin (px)</label>
            <input type="number" id="watermark-margin" min="0" max="100" value="20">
            <small style="color: #666; font-size: 0.9em;">Margin from edge in pixels</small>
          </div>
          <div class="form-group">
            <label for="watermark-opacity">Watermark Opacity</label>
            <input type="number" id="watermark-opacity" min="0" max="1" step="0.1" value="0.8">
            <small style="color: #666; font-size: 0.9em;">Opacity level (0.0 - 1.0)</small>
          </div>
        </div>
        
        <!-- AYO API Configuration -->
        <h4 style="color: #273c75; margin-top: 2rem;">AYO API Configuration</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
          <div class="form-group">
            <label for="ayoindo-api-base-endpoint">API Base Endpoint</label>
            <input type="text" id="ayoindo-api-base-endpoint" placeholder="https://api.ayoindo.com">
            <small style="color: #666; font-size: 0.9em;">Base URL for AYO API</small>
          </div>
          <div class="form-group">
            <label for="ayoindo-api-token">API Token</label>
            <div class="password-input-container">
              <input type="password" id="ayoindo-api-token" class="password-input" placeholder="Enter API token">
              <button type="button" class="toggle-password" onclick="togglePassword('ayoindo-api-token')">
                <span class="eye-icon">🙈</span>
              </button>
            </div>
            <small style="color: #666; font-size: 0.9em;">Authentication token for AYO API</small>
          </div>
        </div>
        

        
        <h4 style="color: #273c75; margin-top: 2rem;">Disk Manager Configuration</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
          <div class="form-group">
            <label for="minimum-free-space-gb">Minimum Free Space (GB)</label>
            <input type="number" id="minimum-free-space-gb" min="1" max="1000" value="10">
            <small style="color: #666; font-size: 0.9em;">Minimum free space required on a disk before it's considered full (1-1000 GB)</small>
          </div>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
          <h5 style="color: #273c75; margin-bottom: 1rem;">Disk Priorities (Lower number = Higher priority)</h5>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            <div class="form-group">
              <label for="priority-external">External Drives</label>
              <input type="number" id="priority-external" min="1" max="10" value="1">
              <small style="color: #666; font-size: 0.9em;">USB drives, external HDDs/SSDs</small>
            </div>
            <div class="form-group">
              <label for="priority-mounted-storage">Mounted Storage</label>
              <input type="number" id="priority-mounted-storage" min="1" max="10" value="2">
              <small style="color: #666; font-size: 0.9em;">Network drives, mounted volumes</small>
            </div>
            <div class="form-group">
              <label for="priority-internal-nvme">Internal NVMe</label>
              <input type="number" id="priority-internal-nvme" min="1" max="10" value="3">
              <small style="color: #666; font-size: 0.9em;">Internal NVMe SSDs</small>
            </div>
            <div class="form-group">
              <label for="priority-internal-sata">Internal SATA</label>
              <input type="number" id="priority-internal-sata" min="1" max="10" value="4">
              <small style="color: #666; font-size: 0.9em;">Internal SATA drives</small>
            </div>
            <div class="form-group">
              <label for="priority-root-filesystem">Root Filesystem</label>
              <input type="number" id="priority-root-filesystem" min="1" max="10" value="5">
              <small style="color: #666; font-size: 0.9em;">System root partition (fallback)</small>
            </div>
          </div>
        </div>
        
        <div style="margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #273c75;">
          <h5 style="margin: 0 0 0.5rem 0; color: #273c75;">Configuration Notes:</h5>
          <ul style="margin: 0; padding-left: 1.5rem; color: #666;">
            <li>Worker concurrency settings control how many tasks can be processed simultaneously</li>
            <li>Higher concurrency may improve performance but will use more system resources</li>
            <li>Quality presets determine which video qualities are available for transcoding</li>
            <li>Disk manager settings control automatic disk selection and storage management</li>
            <li>Lower priority numbers mean higher priority (1 = highest, 10 = lowest)</li>
            <li>Changes will take effect immediately after saving (hot reload enabled)</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- System Health -->
    <section class="tab-section" id="tab-system" style="display:none">
      <h3>System Health</h3>
      <div class="summary-cards">
        <div class="card">
          <h2 id="sys-cpu">-</h2>
          <span>CPU Usage</span>
        </div>
        <div class="card">
          <h2 id="sys-mem">-</h2>
          <span>Memory Usage</span>
        </div>
        <div class="card">
          <h2 id="sys-goroutines">-</h2>
          <span>Goroutines</span>
        </div>
        <div class="card">
          <h2 id="sys-uptime">-</h2>
          <span>Uptime</span>
        </div>
        <div class="card">
          <h2 id="sys-storage">-</h2>
          <span>Storage Used</span>
        </div>
      </div>
    </section>

    <!-- Logs -->
    <section class="tab-section" id="tab-logs" style="display:none">
      <h3>Recent Errors / Logs</h3>
      <div class="log-list" id="log-list">
        [2025-04-26 11:40] Cam2: Connection lost<br>
        [2025-04-26 11:41] vid124: Processing failed<br>
        ...
      </div>
      <button style="background:#273c75;color:#fff;border:none;padding:0.6em 1.5em;border-radius:6px;">Download Logs</button>
    </section>
  </div>
  
  <!-- Video Modal -->
  <div id="video-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h4 id="modal-camera-name">Camera Stream</h4>
        <span class="close-modal">&times;</span>
      </div>
      <div class="video-container">
        <video id="video-player" controls></video>
      </div>
      <div class="video-controls">
        <button id="refresh-stream">Refresh Stream</button>
      </div>
    </div>
  </div>
  
  <!-- HLS.js Script -->
  <script src="/dashboard/js/hls.min.js"></script>
  <script>
    let cameras = null;
    let videos = null;

    // Fetch cameras from backend
    async function fetchCameras() {
      const res = await fetch('/api/cameras');
      if (!res.ok) throw new Error('Failed to fetch cameras');
      cameras = await res.json();
    }
    // Fetch videos from backend
    async function fetchVideos() {
      const res = await fetch('/api/videos');
      if (!res.ok) throw new Error('Failed to fetch videos');
      videos = await res.json();
    }

    // Tab navigation
    document.querySelectorAll('nav a').forEach(tab => {
      tab.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('nav a').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        const tabName = this.getAttribute('data-tab');
        document.querySelectorAll('.tab-section').forEach(sec => sec.style.display = 'none');
        document.getElementById('tab-' + tabName).style.display = '';
      });
    });

    // Populate Cameras Table
    function renderCameras() {
      const search = document.getElementById('camera-search').value.toLowerCase();
      const status = document.getElementById('camera-status-filter').value;
      const tbody = document.querySelector('#cameras-table tbody');
      tbody.innerHTML = '';
      if (!Array.isArray(cameras)) return;
      cameras.forEach(cam => {
        if ((status === 'all' || cam.status === status) &&
            (cam.name.toLowerCase().includes(search) || cam.ip.includes(search))) {
          tbody.innerHTML += `<tr>
            <td>${cam.name}</td><td>${cam.ip}</td><td>${cam.port}</td><td>${cam.path}</td>
            <td><span class="status ${cam.status}">${cam.status.toUpperCase()}</span></td>
            <td>${cam.last_checked ? new Date(cam.last_checked).toLocaleString() : ''}</td>
            <td class="actions"><button onclick="openVideoStream('${cam.name}')">View</button></td>
          </tr>`;
        }
      });
    }
    document.getElementById('camera-search').addEventListener('input', renderCameras);
    document.getElementById('camera-status-filter').addEventListener('change', renderCameras);

    // Populate Videos Table
    function renderVideos() {
      const status = document.getElementById('video-status-filter').value;
      const camera = document.getElementById('video-camera-filter').value;
      const date = document.getElementById('video-date-filter').value;
      const idSearch = document.getElementById('video-id-search').value.toLowerCase();
      const tbody = document.querySelector('#videos-table tbody');
      tbody.innerHTML = '';
      if (!Array.isArray(videos)) return;
      videos.forEach(v => {
        if ((status === 'all' || v.status === status)
          && (camera === 'all' || v.camera === camera)
          && (idSearch === '' || v.id.toLowerCase().includes(idSearch))
          && (date === '' || v.createdAt.startsWith(date))) {
          tbody.innerHTML += `<tr>
            <td>${v.id}</td><td>${v.camera}</td><td><span class="status ${v.status}">${v.status}</span></td>
            <td>${v.createdAt}</td><td>${v.duration}</td><td>${v.size}</td><td>${v.cloud ? 'Yes' : 'No'}</td><td>${v.error}</td>
            <td class="actions">${v.action === 'view' ? '<button>View</button>' : v.action === 'retry' ? '<button>Retry</button>' : ''}</td>
          </tr>`;
        }
      });
    }
    document.getElementById('video-status-filter').addEventListener('change', renderVideos);
    document.getElementById('video-camera-filter').addEventListener('change', renderVideos);
    document.getElementById('video-date-filter').addEventListener('change', renderVideos);
    document.getElementById('video-id-search').addEventListener('input', renderVideos);

    // Populate camera filter for videos
    function populateVideoCameraFilter() {
      const camFilter = document.getElementById('video-camera-filter');
      camFilter.innerHTML = '<option value="all">Camera: All</option>';
      if (!Array.isArray(cameras)) return;
      cameras.forEach(cam => {
        const opt = document.createElement('option');
        opt.value = cam.name;
        opt.textContent = cam.name;
        camFilter.appendChild(opt);
      });
    }

    // Update summary cards with real data
    function updateSummaryCards() {
      // Cameras
      const cameraCount = Array.isArray(cameras) ? cameras.length : 0;
      const activeCount = Array.isArray(cameras) ? cameras.filter(c => c.status === 'online').length : 0;
      document.querySelector('#summary-cards .card:nth-child(1) h2').textContent = cameraCount;
      document.querySelector('#summary-cards .card:nth-child(2) h2').textContent = activeCount;
      // Failed videos
      const failedCount = Array.isArray(videos) ? videos.filter(v => v.status === 'failed').length : 0;
      document.querySelector('#summary-cards .card:nth-child(3) h2').textContent = failedCount;
    }

    // Update system health
    function updateSystemHealth() {
      fetch('/api/system_health').then(res => res.json()).then(data => {
        document.getElementById('sys-cpu').textContent = (data.cpu !== undefined) ? Math.round(data.cpu) + '%' : '-';
        document.getElementById('sys-mem').textContent = (data.memory_used !== undefined && data.memory_total !== undefined)
          ? Math.round(data.memory_used) + 'MB / ' + Math.round(data.memory_total) + 'MB'
          : '-';
        document.getElementById('sys-goroutines').textContent = (data.goroutines !== undefined) ? data.goroutines : '-';
        // Uptime and Storage Used: backend must provide these in the API for live data
        document.getElementById('sys-uptime').textContent = data.uptime || '-';
        document.getElementById('sys-storage').textContent = data.storage || '-';
      });
    }
    setInterval(updateSystemHealth, 5000);
    updateSystemHealth();

    // Update logs
    function updateLogs() {
      fetch('/api/logs').then(res => res.text()).then(data => {
        const logList = document.getElementById('log-list');
        logList.innerHTML = data
          .replace(/\n/g, '<br>')
          .replace(/\033\[[0-9;]*m/g, ''); // strip ANSI colors if any
        logList.scrollTop = logList.scrollHeight; // auto-scroll to bottom
      });
    }
    setInterval(updateLogs, 5000);
    updateLogs();

    // Initial load: fetch data and render tables
    async function initDashboard() {
      try {
        await fetchCameras();
        await fetchVideos();
      } catch (e) {
        alert('Failed to load dashboard data: ' + e.message);
        return;
      }
      populateVideoCameraFilter();
      renderCameras();
      renderVideos();
      updateSummaryCards();
    }
    // Video streaming functionality
    const videoModal = document.getElementById('video-modal');
    const modalCameraName = document.getElementById('modal-camera-name');
    const videoPlayer = document.getElementById('video-player');
    let currentHls = null;
    
    // Open video stream modal
    function openVideoStream(cameraName) {
      modalCameraName.textContent = `${cameraName} - Live Stream`;
      videoModal.style.display = 'block';
      
      // Check if HLS.js is loaded
      if (typeof Hls === 'undefined') {
        console.error('HLS.js is not loaded. Attempting to load it now.');
        const script = document.createElement('script');
        script.src = '/dashboard/js/hls.min.js';
        script.onload = function() {
          console.log('HLS.js loaded successfully');
          loadStream(cameraName);
        };
        script.onerror = function() {
          console.error('Failed to load HLS.js');
          alert('Failed to load video player library. Please refresh the page and try again.');
        };
        document.head.appendChild(script);
      } else {
        // Load the stream using HLS.js
        loadStream(cameraName);
      }
    }
    
    // Load HLS stream
    function loadStream(cameraName) {
      // Clean up previous stream if exists
      if (currentHls) {
        currentHls.destroy();
        currentHls = null;
      }
      
      // Format camera name for folder structure (lowercase, replace spaces with underscores)
      const formattedCameraName = cameraName.replace(/\s+/g, '_');
      
      // Path to the HLS stream - using the server's static file configuration
      const streamUrl = `/hls/${formattedCameraName}/hls/playlist.m3u8`;
      
      // Check if Hls is defined
      if (typeof Hls !== 'undefined' && Hls.isSupported()) {
        currentHls = new Hls({
          debug: false,
          // Set appropriate HLS configuration
          maxBufferLength: 30,
          maxMaxBufferLength: 60,
          liveSyncDuration: 3,
          liveMaxLatencyDuration: 10,
          liveDurationInfinity: true
        });
        
        currentHls.loadSource(streamUrl);
        currentHls.attachMedia(videoPlayer);
        
        currentHls.on(Hls.Events.MANIFEST_PARSED, function() {
          videoPlayer.play();
        });
        
        currentHls.on(Hls.Events.ERROR, function(event, data) {
          if (data.fatal) {
            switch(data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                console.error('Network error while loading stream');
                // Try to recover network error
                currentHls.startLoad();
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                console.error('Media error while playing stream');
                // Try to recover media error
                currentHls.recoverMediaError();
                break;
              default:
                // Cannot recover
                currentHls.destroy();
                currentHls = null;
                console.error('Unrecoverable error', data);
                break;
            }
          }
        });
      } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
        // For Safari and iOS devices that support HLS natively
        videoPlayer.src = streamUrl;
        videoPlayer.addEventListener('loadedmetadata', function() {
          videoPlayer.play();
        });
      } else {
        console.error('HLS is not supported in this browser');
        alert('Your browser does not support HLS streaming');
      }
    }
    
    // Close the modal
    document.querySelector('.close-modal').addEventListener('click', function() {
      videoModal.style.display = 'none';
      // Stop the stream
      if (currentHls) {
        currentHls.destroy();
        currentHls = null;
      }
      videoPlayer.pause();
      videoPlayer.src = '';
    });
    
    // Refresh stream button
    document.getElementById('refresh-stream').addEventListener('click', function() {
      const cameraName = modalCameraName.textContent.split(' - ')[0];
      loadStream(cameraName);
    });
    
    // Close modal when clicking outside of it
    window.addEventListener('click', function(event) {
      if (event.target === videoModal) {
        videoModal.style.display = 'none';
        // Stop the stream
        if (currentHls) {
          currentHls.destroy();
          currentHls = null;
        }
        videoPlayer.pause();
        videoPlayer.src = '';
      }
    });
    
    window.addEventListener('DOMContentLoaded', initDashboard);
    // Camera Config Management
    const cameraConfig = {
      cameras: []
    };
    
    // DOM Elements
    const cameraConfigTab = document.getElementById('tab-camera-config');
    const cameraTableBody = document.getElementById('camera-config-tbody');
    const addCameraBtn = document.getElementById('add-camera-btn');
    const saveConfigBtn = document.getElementById('save-config-btn');
    const reloadConfigBtn = document.getElementById('reload-config-btn');
    const cameraForm = document.getElementById('camera-form');
    const cameraModal = document.getElementById('camera-form-modal');
    const closeModal = document.querySelector('.close');
    const cancelCameraBtn = document.getElementById('cancel-camera');

    // Event Listeners
    addCameraBtn.addEventListener('click', () => openCameraModal());
    saveConfigBtn.addEventListener('click', saveCameraConfig);
    reloadConfigBtn.addEventListener('click', fetchCameraConfig);
    closeModal.addEventListener('click', () => cameraModal.style.display = 'none');
    cancelCameraBtn.addEventListener('click', () => cameraModal.style.display = 'none');
    window.addEventListener('click', (e) => {
      if (e.target === cameraModal) {
        cameraModal.style.display = 'none';
      }
    });
    cameraForm.addEventListener('submit', handleCameraFormSubmit);

    // Tab switching
    document.querySelectorAll('nav a').forEach(tab => {
      tab.addEventListener('click', function(e) {
        // Show the corresponding tab content
        document.querySelectorAll('.tab-section').forEach(section => {
          section.style.display = 'none';
        });
        const tabId = this.getAttribute('data-tab');
        document.getElementById(`tab-${tabId}`).style.display = 'block';
        
        // Update active tab
        document.querySelectorAll('nav a').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // If switching to camera config tab, refresh the config
        if (tabId === 'camera-config') {
          fetchCameraConfig();
        }
      });
    });

    // Camera Form Handler
    async function handleCameraFormSubmit(e) {
      e.preventDefault();
      
      const camera = {
        name: document.getElementById('camera-name').value,
        ip: document.getElementById('camera-ip').value,
        port: document.getElementById('camera-port').value,
        path: document.getElementById('camera-path').value,
        username: document.getElementById('camera-username').value,
        // Only include password if it was changed (not empty)
        ...(document.getElementById('camera-password').value && { 
          password: document.getElementById('camera-password').value 
        }),
        field: document.getElementById('camera-field-id').value || 'main',
        button_no: document.getElementById('camera-button-no').value || '',
        enabled: document.getElementById('camera-enabled').checked,
        width: 1920, // Default values, can be made configurable
        height: 1080,
        frame_rate: 30,
        resolution: '1080p',
        auto_delete: 7 // Default 7 days
      };
      
      const index = parseInt(document.getElementById('camera-index').value);
      
      try {
        if (index >= 0 && index < cameraConfig.cameras.length) {
          // Update existing camera - preserve existing fields not in the form
          const existingCamera = cameraConfig.cameras[index];
          cameraConfig.cameras[index] = { ...existingCamera, ...camera };
        } else {
          // Add new camera
          cameraConfig.cameras.push(camera);
        }
        
        // Save changes to backend
        await saveCameraConfig();
        
        // Only update UI if save was successful
        renderCameraTable();
        cameraModal.style.display = 'none';
        cameraForm.reset();
        
      } catch (error) {
        console.error('Error saving camera:', error);
        showNotification(`Error saving camera: ${error.message}`, 'error');
      }
    }
    
    // Open camera modal for adding/editing
    function openCameraModal(camera = null, index = -1) {
      const modalTitle = document.getElementById('modal-title');
      const cameraIndex = document.getElementById('camera-index');
      
      if (camera) {
        modalTitle.textContent = 'Edit Camera';
        cameraIndex.value = index;
        document.getElementById('camera-name').value = camera.name || '';
        document.getElementById('camera-ip').value = camera.ip || '';
        document.getElementById('camera-port').value = camera.port || '80';
        document.getElementById('camera-path').value = camera.path || '/video/mjpg.cgi';
        document.getElementById('camera-username').value = camera.username || '';
        document.getElementById('camera-password').value = camera.password || ''; // Include password for editing
        document.getElementById('camera-field-id').value = camera.field || '';
        document.getElementById('camera-button-no').value = camera.button_no || '';
        document.getElementById('camera-enabled').checked = camera.enabled !== false;
      } else {
        modalTitle.textContent = 'Add Camera';
        cameraIndex.value = '-1';
        cameraForm.reset();
      }
      
      cameraModal.style.display = 'block';
    }
    
    // Delete camera
    function deleteCamera(index) {
      if (confirm('Are you sure you want to delete this camera?')) {
        cameraConfig.cameras.splice(index, 1);
        renderCameraTable();
      }
    }
    
    // Render camera table
    function renderCameraTable() {
      cameraTableBody.innerHTML = '';
      
      if (cameraConfig.cameras.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="9" style="text-align: center;">No cameras configured</td>';
        cameraTableBody.appendChild(row);
        return;
      }
      
      cameraConfig.cameras.forEach((camera, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${camera.name}</td>
          <td>${camera.ip}</td>
          <td>${camera.port || '80'}</td>
          <td>${camera.path || ''}</td>
          <td>${camera.username || ''}</td>
          <td>${camera.field || ''}</td>
          <td>${camera.button_no || ''}</td>
          <td>${camera.enabled ? '✅' : '❌'}</td>
          <td class="camera-actions">
            <button class="btn btn-primary btn-sm edit-camera" data-index="${index}">Edit</button>
            <button class="btn btn-danger btn-sm delete-camera" data-index="${index}">Delete</button>
          </td>
        `;
        cameraTableBody.appendChild(row);
      });
      
      // Add event listeners to the new buttons
      document.querySelectorAll('.edit-camera').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.getAttribute('data-index'));
          openCameraModal(cameraConfig.cameras[index], index);
        });
      });
      
      document.querySelectorAll('.delete-camera').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.getAttribute('data-index'));
          if (confirm('Are you sure you want to delete this camera?')) {
            cameraConfig.cameras.splice(index, 1);
            renderCameraTable();
          }
        });
      });
    }
    
    // Fetch camera config from API
    async function fetchCameraConfig() {
      try {
        const response = await fetch('/api/admin/cameras-config');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const result = await response.json();
        if (result.success) {
          cameraConfig.cameras = result.data;
          renderCameraTable();
          showNotification('Camera configuration loaded successfully', 'success');
        } else {
          throw new Error(result.error || 'Failed to load camera config');
        }
      } catch (error) {
        console.error('Error fetching camera config:', error);
        showNotification(`Error: ${error.message}`, 'error');
      }
    }
    
    // Save camera config to API
    async function saveCameraConfig() {
      try {
        // Prepare the data to send
        const camerasToSave = cameraConfig.cameras.map(camera => ({
          name: camera.name,
          ip: camera.ip,
          port: camera.port,
          path: camera.path,
          username: camera.username,
          // Only include password if it was changed (not empty)
          ...(camera.password && { password: camera.password }),
          button_no: camera.button_no || '',
          enabled: camera.enabled,
          width: camera.width || 1920,
          height: camera.height || 1080,
          frame_rate: camera.frame_rate || 30,
          field: camera.field || 'main',
          resolution: camera.resolution || '1080p',
          auto_delete: camera.auto_delete || 7
        }));

        const response = await fetch('/api/admin/cameras-config', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ cameras: camerasToSave })
        });
        
        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || `HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        // Automatically reload cameras after saving to apply new configuration
        try {
          const reloadResponse = await fetch('/api/admin/reload-cameras', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            }
          });
          
          if (reloadResponse.ok) {
            showNotification('Camera configuration saved and reloaded successfully', 'success');
          } else {
            showNotification('Camera configuration saved, but reload failed. Please manually reload.', 'warning');
          }
        } catch (reloadError) {
          console.error('Error reloading cameras:', reloadError);
          showNotification('Camera configuration saved, but reload failed. Please manually reload.', 'warning');
        }
        
        // Update local config with the saved data
        cameraConfig.cameras = result.data || camerasToSave;
        return true;
      } catch (error) {
        console.error('Error saving camera config:', error);
        showNotification(`Error: ${error.message}`, 'error');
        throw error; // Re-throw to allow handling in the calling function
      }
    }
    
    // Show notification
    function showNotification(message, type = 'info') {
      // Simple notification system - you might want to use a library like Toastr in production
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }
    
    // Toggle password visibility
    function togglePasswordVisibility(button) {
      const container = button.closest('.password-input-container');
      const input = container.querySelector('.password-input');
      const isPassword = input.type === 'password';
      
      // Toggle the input type
      input.type = isPassword ? 'text' : 'password';
      
      // Update the button text/icon
      const icon = button.querySelector('.eye-icon');
      if (icon) {
        icon.textContent = isPassword ? '🙈' : '👁️';
      }
      
      // Update ARIA attributes for accessibility
      button.setAttribute('aria-label', 
        isPassword ? 'Hide password' : 'Show password');
    }
    
    // Add event listeners for password toggles
    function initPasswordToggles() {
      document.querySelectorAll('.toggle-password').forEach(button => {
        // Remove any existing listeners to prevent duplicates
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        
        // Add click event
        newButton.addEventListener('click', (e) => {
          togglePasswordVisibility(e.currentTarget);
        });
        
        // Add keyboard support (Enter/Space)
        newButton.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            togglePasswordVisibility(e.currentTarget);
          }
        });
      });
    }
    
    // Update the openCameraModal function to handle password display
    const originalOpenCameraModal = openCameraModal;
    openCameraModal = function(camera = null, index = -1) {
      originalOpenCameraModal(camera, index);
      // Re-initialize password toggles after modal is opened
      setTimeout(initPasswordToggles, 0);
    };
    
    // Initialize the dashboard
    window.addEventListener('DOMContentLoaded', () => {
      initDashboard();
      initPasswordToggles();
      initSystemConfig();
    });
  </script>
  <!-- Arduino Config Modal -->
  <div id="arduino-modal" class="modal">
    <div class="modal-content">
      <span class="close" id="close-arduino-modal">&times;</span>
      <h3>Arduino Configuration</h3>
      <div class="form-group">
        <label for="arduino-port">COM Port</label>
        <input type="text" id="arduino-port">
      </div>
      <div class="form-group">
        <label for="arduino-baud">Baud Rate</label>
        <input type="number" id="arduino-baud">
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" id="save-arduino-btn">Save</button>
        <button class="btn btn-secondary" id="cancel-arduino-btn">Cancel</button>
      </div>
    </div>
  </div>

<script>
// ---------- System Config ----------
let systemConfig = {};

// Load system configuration from backend
async function loadSystemConfig() {
  try {
    const response = await fetch('/api/admin/system-config');
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const result = await response.json();
    systemConfig = result.data || {};
    
    // Worker Concurrency Settings
    document.getElementById('booking-worker-concurrency').value = 
      systemConfig['booking_worker_concurrency'] || 2;
    document.getElementById('video-request-worker-concurrency').value = 
      systemConfig['video_request_worker_concurrency'] || 3;
    document.getElementById('pending-task-worker-concurrency').value = 
      systemConfig['pending_task_worker_concurrency'] || 5;
    
    // Quality Settings
    const enabledQualities = (systemConfig['enabled_qualities'] || '1080p,720p,480p,360p').split(',');
    document.querySelectorAll('.quality-checkbox').forEach(checkbox => {
      checkbox.checked = enabledQualities.includes(checkbox.value);
    });
    
    // Video Processing Settings
    document.getElementById('enable-video-duration-check').checked = 
      systemConfig['enable_video_duration_check'] === 'true';
    
    // Venue Configuration (no defaults)
    document.getElementById('venue-code').value = systemConfig['venue_code'] || '';
    document.getElementById('venue-secret-key').value = systemConfig['venue_secret_key'] || '';
    
    // Arduino Configuration
    document.getElementById('arduino-com-port').value = systemConfig['arduino_com_port'] || '/dev/ttyUSB0';
    document.getElementById('arduino-baud-rate').value = systemConfig['arduino_baud_rate'] || 9600;
    
    // RTSP Configuration
    document.getElementById('rtsp-username').value = systemConfig['rtsp_username'] || 'admin';
    document.getElementById('rtsp-password').value = systemConfig['rtsp_password'] || 'admin123';
    document.getElementById('rtsp-ip').value = systemConfig['rtsp_ip'] || '192.168.1.100';
    document.getElementById('rtsp-port').value = systemConfig['rtsp_port'] || 554;
    document.getElementById('rtsp-path').value = systemConfig['rtsp_path'] || '/stream1';
    
    // Recording Configuration
    document.getElementById('segment-duration').value = systemConfig['segment_duration'] || 10;
    document.getElementById('clip-duration').value = systemConfig['clip_duration'] || 30;
    document.getElementById('width').value = systemConfig['width'] || 1920;
    document.getElementById('height').value = systemConfig['height'] || 1080;
    document.getElementById('frame-rate').value = systemConfig['frame_rate'] || 30;
    document.getElementById('resolution').value = systemConfig['resolution'] || '1920x1080';
    document.getElementById('auto-delete').value = systemConfig['auto_delete'] || 30;
    
    // Storage Configuration
    document.getElementById('storage-path').value = systemConfig['storage_path'] || './storage';
    document.getElementById('hardware-accel').checked = systemConfig['hardware_accel'] === 'true';
    document.getElementById('codec').value = systemConfig['codec'] || 'h264';
    
    // Server Configuration
    document.getElementById('server-port').value = systemConfig['server_port'] || 8080;
    document.getElementById('base-url').value = systemConfig['base_url'] || 'http://localhost:8080';

    
    // R2 Storage Configuration
    document.getElementById('r2-enabled').checked = systemConfig['r2_enabled'] === 'true';
    document.getElementById('r2-access-key').value = systemConfig['r2_access_key'] || '';
    document.getElementById('r2-secret-key').value = systemConfig['r2_secret_key'] || '';
    document.getElementById('r2-account-id').value = systemConfig['r2_account_id'] || '';
    document.getElementById('r2-bucket').value = systemConfig['r2_bucket'] || 'ayo-mwr';
    document.getElementById('r2-region').value = systemConfig['r2_region'] || 'auto';
    document.getElementById('r2-endpoint').value = systemConfig['r2_endpoint'] || '';
    document.getElementById('r2-base-url').value = systemConfig['r2_base_url'] || '';
    document.getElementById('r2-token-value').value = systemConfig['r2_token_value'] || '';
    
    // Watermark Configuration
    document.getElementById('watermark-position').value = systemConfig['watermark_position'] || 'bottom_right';
    document.getElementById('watermark-margin').value = systemConfig['watermark_margin'] || 20;
    document.getElementById('watermark-opacity').value = systemConfig['watermark_opacity'] || 0.8;
    
    // AYO API Configuration
    document.getElementById('ayoindo-api-base-endpoint').value = systemConfig['ayoindo_api_base_endpoint'] || 'https://api.ayoindo.com';
    document.getElementById('ayoindo-api-token').value = systemConfig['ayoindo_api_token'] || '';
    

    
    // Disk Manager Configuration
    document.getElementById('minimum-free-space-gb').value = systemConfig['minimum_free_space_gb'] || 100;
    document.getElementById('priority-external').value = systemConfig['priority_external'] || 1;
    document.getElementById('priority-mounted-storage').value = systemConfig['priority_mounted_storage'] || 50;
    document.getElementById('priority-internal-nvme').value = systemConfig['priority_internal_nvme'] || 101;
    document.getElementById('priority-internal-sata').value = systemConfig['priority_internal_sata'] || 201;
    document.getElementById('priority-root-filesystem').value = systemConfig['priority_root_filesystem'] || 500;
    
    showNotification('System configuration loaded successfully', 'success');
  } catch (error) {
    console.error('Error loading system config:', error);
    showNotification(`Error loading system config: ${error.message}`, 'error');
  }
}

// Load disk manager configuration from backend
async function loadDiskManagerConfig() {
  try {
    const response = await fetch('/api/admin/disk-manager-config');
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const result = await response.json();
    const config = result.data || {};
    
    // Update disk manager form fields with loaded values
    document.getElementById('minimum-free-space-gb').value = 
      config.minimum_free_space_gb || 10;
    document.getElementById('priority-external').value = 
      config.priority_external || 1;
    document.getElementById('priority-mounted-storage').value = 
      config.priority_mounted_storage || 2;
    document.getElementById('priority-internal-nvme').value = 
      config.priority_internal_nvme || 3;
    document.getElementById('priority-internal-sata').value = 
      config.priority_internal_sata || 4;
    document.getElementById('priority-root-filesystem').value = 
      config.priority_root_filesystem || 5;
    
  } catch (error) {
    console.error('Error loading disk manager config:', error);
    // Use default values if loading fails
    document.getElementById('minimum-free-space-gb').value = 10;
    document.getElementById('priority-external').value = 1;
    document.getElementById('priority-mounted-storage').value = 2;
    document.getElementById('priority-internal-nvme').value = 3;
    document.getElementById('priority-internal-sata').value = 4;
    document.getElementById('priority-root-filesystem').value = 5;
  }
}

// Save system configuration to backend
async function saveSystemConfig() {
  try {
    // Collect enabled qualities
    const enabledQualities = [];
    document.querySelectorAll('.quality-checkbox:checked').forEach(checkbox => {
      enabledQualities.push(checkbox.value);
    });
    
    const configData = {
      // Worker Concurrency Settings
      'booking_worker_concurrency': parseInt(document.getElementById('booking-worker-concurrency').value),
      'video_request_worker_concurrency': parseInt(document.getElementById('video-request-worker-concurrency').value),
      'pending_task_worker_concurrency': parseInt(document.getElementById('pending-task-worker-concurrency').value),
      
      // Quality Settings
      'enabled_qualities': enabledQualities.join(','),
      
      // Video Processing Settings
      'enable_video_duration_check': document.getElementById('enable-video-duration-check').checked.toString(),
      
      // Venue Configuration
      'venue_code': document.getElementById('venue-code').value,
      'venue_secret_key': document.getElementById('venue-secret-key').value,
      
      // Arduino Configuration
      'arduino_com_port': document.getElementById('arduino-com-port').value,
      'arduino_baud_rate': parseInt(document.getElementById('arduino-baud-rate').value),
      
      // RTSP Configuration
      'rtsp_username': document.getElementById('rtsp-username').value,
      'rtsp_password': document.getElementById('rtsp-password').value,
      'rtsp_ip': document.getElementById('rtsp-ip').value,
      'rtsp_port': parseInt(document.getElementById('rtsp-port').value),
      'rtsp_path': document.getElementById('rtsp-path').value,
      
      // Recording Configuration
      'segment_duration': parseInt(document.getElementById('segment-duration').value),
      'clip_duration': parseInt(document.getElementById('clip-duration').value),
      'width': parseInt(document.getElementById('width').value),
      'height': parseInt(document.getElementById('height').value),
      'frame_rate': parseInt(document.getElementById('frame-rate').value),
      'resolution': document.getElementById('resolution').value,
      'auto_delete': parseInt(document.getElementById('auto-delete').value),
      
      // Storage Configuration
      'storage_path': document.getElementById('storage-path').value,
      'hardware_accel': document.getElementById('hardware-accel').checked.toString(),
      'codec': document.getElementById('codec').value,
      
      // Server Configuration
      'server_port': parseInt(document.getElementById('server-port').value),
      'base_url': document.getElementById('base-url').value,
      
      // R2 Storage Configuration
      'r2_enabled': document.getElementById('r2-enabled').checked.toString(),
      'r2_access_key': document.getElementById('r2-access-key').value,
      'r2_secret_key': document.getElementById('r2-secret-key').value,
      'r2_account_id': document.getElementById('r2-account-id').value,
      'r2_bucket': document.getElementById('r2-bucket').value,
      'r2_region': document.getElementById('r2-region').value,
      'r2_endpoint': document.getElementById('r2-endpoint').value,
      'r2_base_url': document.getElementById('r2-base-url').value,
      'r2_token_value': document.getElementById('r2-token-value').value,
      
      // Watermark Configuration
      'watermark_position': document.getElementById('watermark-position').value,
      'watermark_margin': parseInt(document.getElementById('watermark-margin').value),
      'watermark_opacity': parseFloat(document.getElementById('watermark-opacity').value),
      
      // AYO API Configuration
      'ayoindo_api_base_endpoint': document.getElementById('ayoindo-api-base-endpoint').value,
      'ayoindo_api_token': document.getElementById('ayoindo-api-token').value,
      

      
      // Disk Manager Configuration
      'minimum_free_space_gb': parseInt(document.getElementById('minimum-free-space-gb').value),
      'priority_external': parseInt(document.getElementById('priority-external').value),
      'priority_mounted_storage': parseInt(document.getElementById('priority-mounted-storage').value),
      'priority_internal_nvme': parseInt(document.getElementById('priority-internal-nvme').value),
      'priority_internal_sata': parseInt(document.getElementById('priority-internal-sata').value),
      'priority_root_filesystem': parseInt(document.getElementById('priority-root-filesystem').value)
    };
    
    // Validate worker concurrency data
    if (configData['booking_worker_concurrency'] < 1 || configData['booking_worker_concurrency'] > 10 ||
        configData['video_request_worker_concurrency'] < 1 || configData['video_request_worker_concurrency'] > 10 ||
        configData['pending_task_worker_concurrency'] < 1 || configData['pending_task_worker_concurrency'] > 10) {
      throw new Error('Worker concurrency values must be between 1 and 10');
    }
    
    if (enabledQualities.length === 0) {
      throw new Error('At least one quality preset must be enabled');
    }
    
    // Send system config to backend
    const response = await fetch('/api/admin/system-config', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(configData)
    });
    
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error.error || `HTTP error! status: ${response.status}`);
    }
    
    const result = await response.json();
    systemConfig = { ...systemConfig, ...configData };
    
    showNotification('System configuration saved successfully', 'success');
    
  } catch (error) {
    console.error('Error saving system config:', error);
    showNotification(`Error saving system config: ${error.message}`, 'error');
  }
}

// Save disk manager configuration to backend
async function saveDiskManagerConfig() {
  try {
    // Collect disk manager form data
    const diskManagerData = {
      minimum_free_space_gb: parseInt(document.getElementById('minimum-free-space-gb').value),
      priority_external: parseInt(document.getElementById('priority-external').value),
      priority_mounted_storage: parseInt(document.getElementById('priority-mounted-storage').value),
      priority_internal_nvme: parseInt(document.getElementById('priority-internal-nvme').value),
      priority_internal_sata: parseInt(document.getElementById('priority-internal-sata').value),
      priority_root_filesystem: parseInt(document.getElementById('priority-root-filesystem').value)
    };
    
    // Validate disk manager data
    if (diskManagerData.minimum_free_space_gb < 1 || diskManagerData.minimum_free_space_gb > 1000) {
      throw new Error('Minimum free space must be between 1 and 1000 GB');
    }
    
    const priorities = [
      diskManagerData.priority_external,
      diskManagerData.priority_mounted_storage,
      diskManagerData.priority_internal_nvme,
      diskManagerData.priority_internal_sata,
      diskManagerData.priority_root_filesystem
    ];
    
    for (const priority of priorities) {
      if (priority < 1 || priority > 1000) {
        throw new Error('All priority values must be between 1 and 1000');
      }
    }
    
    // Send disk manager config to backend
    const response = await fetch('/api/admin/disk-manager-config', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(diskManagerData)
    });
    
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error.error || `HTTP error! status: ${response.status}`);
    }
    
  } catch (error) {
    console.error('Error saving disk manager config:', error);
    throw error; // Re-throw to be caught by parent function
  }
}

// Initialize system config event listeners
function initSystemConfig() {
  document.getElementById('load-system-config-btn').addEventListener('click', loadSystemConfig);
  document.getElementById('save-system-config-btn').addEventListener('click', saveSystemConfig);
  
  // Auto-load config when tab is first accessed
  let systemConfigLoaded = false;
  document.querySelector('nav a[data-tab="system-config"]').addEventListener('click', () => {
    if (!systemConfigLoaded) {
      loadSystemConfig();
      systemConfigLoaded = true;
    }
  });
}

// ---------- Arduino status ----------
async function fetchArduinoStatus() {
  try {
    const res = await fetch('/api/arduino-status');
    const data = await res.json();
    const card = document.getElementById('arduino-status-card');
    const txt = document.getElementById('arduino-status-text');
    const details = document.getElementById('arduino-status-details');
    txt.textContent = data.connected ? 'Connected' : 'Disconnected';
    details.textContent = `Port: ${data.port || '-'} | Baud: ${data.baud_rate || '-'}`;
    card.style.background = data.connected ? 'var(--success-color)' : 'var(--danger-color)';
    txt.style.color = '#fff';
    details.style.color = '#fff';
  } catch(e) {
    console.error('Failed to fetch Arduino status', e);
  }
}
setInterval(fetchArduinoStatus, 60000);
fetchArduinoStatus();

// open config modal
const arduinoCard = document.getElementById('arduino-status-card');
const arduinoModal = document.getElementById('arduino-modal');
const closeArduinoModal = document.getElementById('close-arduino-modal');
const cancelArduinoBtn = document.getElementById('cancel-arduino-btn');
arduinoCard.addEventListener('click', () => {
  loadArduinoConfig();
  arduinoModal.style.display='block';
});
closeArduinoModal.onclick = cancelArduinoBtn.onclick = () => {
  arduinoModal.style.display='none';
};

async function loadArduinoConfig(){
  try{
    const res = await fetch('/api/arduino-status');
    const d = await res.json();
    document.getElementById('arduino-port').value = d.port || '';
    document.getElementById('arduino-baud').value = d.baud_rate || '';
  }catch(e){console.error(e);}
}

document.getElementById('save-arduino-btn').addEventListener('click', async ()=>{
  const port = document.getElementById('arduino-port').value.trim();
  const baud = parseInt(document.getElementById('arduino-baud').value,10);
  if(!port || !baud){showNotification('Port and baud required','warning');return;}
  try{
    const res = await fetch('/api/admin/arduino-config',{
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({port:port, baud_rate: baud})
    });
    const txt = await res.text();
    if(res.ok){
      showNotification('Arduino config saved','success');
      arduinoModal.style.display='none';
      fetchArduinoStatus();
    }else{
      showNotification('Error: '+txt,'error');
    }
  }catch(e){showNotification('Request failed','error');}
});
</script>
</body>
</html>
